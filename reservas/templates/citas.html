{% extends 'principal.html' %}
{% block content %}
<div class="mt-3"><h3>Reservas de citas médicas</h3><hr></div>
{% if mensaje %}
  <div class="alert alert-success" role="alert" style="text-align: center;">{{ mensaje }}</div>
{% endif %}
         <div class="container">
            <form action="{% url 'citas' %}" method="GET">
                {% csrf_token %}
            <div class="row g-2 mb-3">
                <div class="col-2">
                    <h5>Selecionar paciente:</h5>
                </div>
                <div class="col-2">
                    <input type="text" class="form-control" name="ci" placeholder="Introduzca el C.I." required>
                </div>
                <div class="col-2">
                <button type="submit" class="btn btn btn-outline-primary btn-cita" style="width: -webkit-fill-available;">Buscar</button>
              </div>
            </form> 
              <div class="col-2">
                {% for horario, ficha in horarios %}
                <input type="text" class="form-control" name="medId" value="{{ horario.medico.planta }}" hidden> 
            </div>
            </div>
          </div>
    <div class="list-group">
    
    <label class="list-group-item d-flex gap-3">
    <div class="row" style="width: -webkit-fill-available;">
        <div class="col-4">
               <span class="pt-1 form-checked-content">
                  <strong>{{ horario }} </strong>
                  <span class="d-block text-body-secondary">Horario: <strong> {{ horario.ingreso | date:"H:iA" | lower}} - {{  horario.salida | time:"H:iA" | lower}} </strong></span>
                  <span>Piso: <strong> {{ horario.medico.planta }} </strong></span>
                  <span>Consultorio: <strong> {{ horario.medico.consultorio }} </strong></span>
               </span>
             </div>
        <div class="col-8">
                <fieldset>
                  {% if error_message %}
                  <p class="error"><strong>{{ error_message }}</strong></p>
                  {% endif %}
                    <div class="form-group mb-3">
                    <div class="input-group">
                        {% if paciente %}
                         <input type="text" id="paciente" class="form-control w-50" style="background-color: rgb(158, 238, 201);" placeholder="Paciente" value="{{ paciente.nombres }} {{ paciente.apellidos }} " readonly>
                         <span class="input-group-addon">-</span>
                         <input id="ci" type="text" required class="form-control" style="background-color: rgb(158, 238, 201);" placeholder="C.I." value="{{ paciente.ci }}" readonly>
                         {% endif %}
                    </div>
                 </div>
                 <form action="{% url 'citas' %}" method="POST">
                  {% csrf_token %}
                 <div class="form-group">
                  <div class="input-group">
                   <input id="diaId" name="diaIdCita" type="hidden" required class="form-control" readonly>
                   <input id="medId" name="medIdCita" type="hidden" required class="form-control" value="{{ horario.medico.id }}" readonly>
                   <input id="pacienteId" name="pacienteIdCita" type="hidden" required class="form-control" value="{{ paciente.id }}" readonly>
                   <input id="777" type="hidden" required class="form-control" value="777" readonly>
                  </div>
                 </div>  
                  <div class="form-group">
                     <div class="input-group">
                      <input id="dia" type="text" required class="form-control" placeholder="Día" readonly>
                      <span class="input-group-addon">-</span>
                      <input id="fecha" name="fechaCita" type="text" required class="form-control" placeholder="Fecha" readonly>
                      <span class="input-group-addon">-</span>
                      <input id="hora" name="horaCita" type="text" required class="form-control" placeholder="Hora" readonly>
                      <span class="input-group-addon">-</span>
                      <input id="ficha" name="fichaCita" type="text" required class="form-control" placeholder="Ficha" readonly>
                      <span class="input-group-addon">-</span>
                      <button type="submit" class="btn btn btn-outline-primary btn-cita">Guardar</button>
                    </div>
                  </div>
                </form>
                 </div>
               </fieldset>
            </div>
     </div>
    </label>

<table class="table table-striped table-bordered table-sm mb-3 tbl-citas">
    <thead>  
    <tr>
    <th style="align-content: center;">Ficha</th>
    <th style="align-content: center;">Hora</th>
        {% if horario.lunes %}<th>Lunes <br>{{ fechas.0 | date:"Y-m-d" }}</th>{% endif %}
        {% if horario.martes %}<th>Martes <br>{{ fechas.1 | date:"Y-m-d" }}</th>{% endif %}   
        {% if horario.miercoles %}<th>Miercoles <br>{{ fechas.2 | date:"Y-m-d" }}</th>{% endif %}  
        {% if horario.jueves %}<th>Jueves <br>{{ fechas.3 | date:"Y-m-d" }}</th>{% endif %}  
        {% if horario.viernes %}<th>Viernes <br>{{ fechas.4 | date:"Y-m-d" }}</th>{% endif %}  
        {% if horario.sabado %}<th>Sabado <br>{{ fechas.5 | date:"Y-m-d" }}</th>{% endif %}  
        {% if horario.domingo %}<th>Domingo <br>{{ fechas.6 | date:"Y-m-d" }}</th>{% endif %}   
    </tr>
</thead>
<tbody>
   {% for turno in ficha %}
        <tr>
            <td class="table-secondary text-center sinId"> {{ forloop.counter }}</td>
            <td class="table-dark text-center sinId"> {{ turno }}</td>
            {% if horario.lunes %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}1"></td>{% endif %}
            {% if horario.martes %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}2"></td>{% endif %}   
            {% if horario.miercoles %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}3"></td>{% endif %}  
            {% if horario.jueves %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}4"></td>{% endif %}  
            {% if horario.viernes %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}5"></td>{% endif %}  
            {% if horario.sabado %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}6"></td>{% endif %}  
            {% if horario.domingo %}<td id="{{ forloop.parentloop.counter }}{{ forloop.counter }}7"></td>{% endif %}   
        </tr>
   {% endfor %}
    </tbody>  
</table>
{% endfor %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">
     {% for reserva in reservas %}
         document.getElementById("1{{reserva.numero_ficha}}{{reserva.dia}}").classList.add('sinId')
         document.getElementById("1{{reserva.numero_ficha}}{{reserva.dia}}").style.backgroundColor = "#dc35457a";
    {% endfor %}
    $('.sinId').click(function(){return false;});
    $('body').on('click', 'table td', function() {
        let idtd = $(this).attr('id');
        let last_idtd = $('#777').val();
        document.getElementById(last_idtd).style.backgroundColor = "transparent";
        document.getElementById(idtd).style.backgroundColor = "#9eeec9";
        $('#777').val(idtd);



        $('#ficha').val($(this).closest("tr").find("td:first-child").text()).css("background-color","#9eeec9");;
        $('#hora').val($(this).closest("tr").find("td:eq(1)").text()).css("background-color","#9eeec9");;
        let dia = parseInt(idtd.charAt(idtd.length - 1));
        let fecha = $(this).closest('table').find('th').eq($(this).index()).text();
        let titulo = fecha.split(" ");
        $('#dia').val(titulo[0]).css("background-color","#9eeec9");
        $('#fecha').val(titulo[1]).css("background-color","#9eeec9");;
        $('#diaId').val(dia);
    });
    </script>
</div>    
{% endblock %}  